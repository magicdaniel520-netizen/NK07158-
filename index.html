<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°¸è¯DCç›¤é»ç³»çµ±</title>
    
    <!-- 1. Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 2. Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- 3. Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 4. html5-qrcode (æ¢ç¢¼æƒæ) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* ç„¡å°é¢¨é…è‰² */
            --muji-bg: #F5F5F3;      
            --muji-card: #FFFFFF;    
            --muji-text: #333333;    
            --muji-sub: #757575;     
            --muji-border: #E0E0E0;  
            
            --primary-color: #555555; 
            --primary-hover: #333333;
            --accent-color: #7F0019;  
            
            --border-radius: 4px;     
            --font-family: 'Noto Sans TC', sans-serif;
        }

        body { 
            background-color: var(--muji-bg); 
            font-family: var(--font-family);
            color: var(--muji-text);
            -webkit-font-smoothing: antialiased;
            letter-spacing: 0.02em;
            overflow-x: hidden;
        }

        .container { padding-left: 12px; padding-right: 12px; }

        .app-header {
            border-bottom: 1px solid #dcdcdc;
            background: var(--muji-bg);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .app-title { font-weight: 700; color: var(--muji-text); font-size: 1.25rem; }

        .main-card {
            background: var(--muji-card);
            border: 1px solid var(--muji-border);
            border-radius: var(--border-radius);
            box-shadow: none; 
            padding: 20px; 
            margin-bottom: 15px;
            position: relative;
        }

        .btn { 
            border-radius: var(--border-radius); 
            font-weight: 500; 
            padding: 10px 15px; 
            border: none;
            letter-spacing: 0.05em;
            font-size: 1rem;
        }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover, .btn-primary:active { background-color: var(--primary-hover) !important; }
        .btn-outline-secondary { border: 1px solid #999; color: #555; background: transparent; }
        .btn-outline-secondary:hover { background: #eee; color: #333; border-color: #555; }
        .btn-accent { background-color: var(--accent-color); color: white; }
        .btn-accent:hover { background-color: #5a0012; color: white; }
        .btn-dark { background-color: #333; color: white; }

        .btn-scan { height: 52px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .form-control { 
            border-radius: var(--border-radius); 
            border: 1px solid var(--muji-border);
            background-color: #FAFAFA;
            padding: 12px 16px; 
            font-size: 1rem;
            color: var(--muji-text);
        }
        .form-control:focus { background-color: #fff; border-color: var(--primary-color); box-shadow: none; outline: 1px solid var(--primary-color); }

        .camera-container {
            position: relative; width: 100%; background: #F0F0F0;
            border-radius: var(--border-radius); margin-bottom: 15px; overflow: hidden;
            min-height: 250px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--muji-border);
        }
        #reader { width: 100%; height: 100%; }

        .nav-pills {
            background: transparent; border: none; border-bottom: 1px solid var(--muji-border);
            padding: 0; gap: 10px; border-radius: 0; flex-wrap: nowrap; overflow-x: auto; 
        }
        .nav-pills .nav-item { flex: 1; text-align: center; }
        .nav-pills .nav-link { 
            border-radius: 0; color: var(--muji-sub); font-weight: 500; 
            padding: 12px 5px; background: transparent; border-bottom: 3px solid transparent;
            margin-bottom: -1px; font-size: 0.95rem; white-space: nowrap;
        }
        .nav-pills .nav-link.active { 
            background-color: transparent; color: var(--accent-color); 
            border-bottom: 3px solid var(--accent-color); font-weight: 700;
        }

        .table-inventory th { 
            font-size: 0.8rem; background-color: transparent; color: var(--muji-sub); 
            padding: 8px 4px; border-bottom: 2px solid var(--muji-border); font-weight: 500;
        }
        .table-inventory td { padding: 12px 4px; vertical-align: middle; border-bottom: 1px solid #EEEEEE; }
        .table-inventory tr:last-child td { border-bottom: none; }
        
        .model-name { font-size: 0.95rem; font-weight: 700; color: #333; margin-bottom: 2px; }
        .model-sub { font-size: 0.75rem; color: #777; }

        .diff-badge { font-size: 0.85rem; padding: 4px 6px; border-radius: 2px; font-weight: 500; font-family: monospace; }
        
        .status-match td { background-color: #F9FDF9; } 
        .status-shortage td { background-color: #FFF5F5; } 
        .status-surplus td { background-color: #F5F9FF; } 

        .text-accent { color: var(--accent-color); }
        .bg-match { background-color: #E8F5E9; color: #2E7D32; }
        .bg-shortage { background-color: #FFEBEE; color: #C62828; }
        .bg-surplus { background-color: #E3F2FD; color: #1565C0; }
        
        /* Last Scan Info Box */
        .last-scan-info {
            background: #fff;
            border: 1px solid var(--muji-border);
            border-radius: var(--border-radius);
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            animation: pulse-border 1.5s infinite;
        }
        .scan-qty {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            font-family: monospace;
        }
        @keyframes pulse-border {
            0% { border-color: var(--muji-border); }
            50% { border-color: var(--primary-color); }
            100% { border-color: var(--muji-border); }
        }

        .suggestion-list {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
            background: white; border: 1px solid var(--muji-border); border-top: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-height: 250px; overflow-y: auto;
        }
        .suggestion-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover { background-color: #fafafa; }

        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        }
        .custom-modal {
            background: #FFFFFF; width: 90%; max-width: 450px; 
            border-radius: var(--border-radius); padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: fadeIn 0.2s ease;
            border: 1px solid #eee;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .big-qty-input { 
            font-size: 2.5rem; font-weight: 300; height: 70px; 
            text-align: center; border: none; background: transparent; 
            color: var(--muji-text); font-family: monospace; width: 80px;
        }
        .big-qty-input:focus { box-shadow: none; outline: none; }
        
        .code-display {
            background: #F0F0F0; color: #555; 
            padding: 4px 8px; border-radius: 2px; 
            font-family: monospace; font-size: 0.85rem; word-break: break-all;
        }

        /* --- åˆ—å°/PDF å°ˆç”¨æ¨£å¼ (Print View) --- */
        #print-footer { display: none; }

        @media print {
            /* å¼·åˆ¶èƒŒæ™¯è‰²èˆ‡åœ–å½¢ */
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                color-adjust: exact !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* éš±è—è¢å¹•ä»‹é¢å…ƒç´  */
            .no-print, .btn, .app-header button, .nav-pills, .camera-container, .input-group, .form-text, label {
                display: none !important;
            }
            
            /* éš±è—è¢å¹•ç‰ˆè¡¨æ ¼ */
            .screen-only-table { display: none !important; }
            
            /* é¡¯ç¤ºä¸¦é‡è¨­åˆ—å°ç‰ˆè¡¨æ ¼çš„å®¹å™¨å±¬æ€§ */
            .print-only-table { 
                display: block !important; 
                overflow: visible !important; 
                height: auto !important;
                border: none !important; 
                padding: 0 !important; 
                box-shadow: none !important; 
                margin: 0 !important;
            }
            
            /* æ¨™é¡Œç·Šæ¹ŠåŒ– */
            .app-header { 
                border-bottom: 2px solid #000; 
                margin-bottom: 10px; 
                padding-bottom: 5px; 
            }
            .app-title { font-size: 14pt; margin: 0; color: #000; }
            
            .main-card, .table-responsive, .main-table-container { 
                border: none !important; 
                padding: 0 !important; 
                box-shadow: none !important; 
                margin: 0 !important;
                overflow: visible !important; 
            }
            
            /* è¡¨æ ¼æœ¬é«”è¨­å®š */
            .table-inventory { 
                width: 100%; 
                border-collapse: collapse; 
                table-layout: fixed; 
            }
            
            /* æ¨™é¡Œåˆ—é‡è¤‡è¨­å®š */
            thead { 
                display: table-header-group; 
            }
            
            tr { 
                page-break-inside: avoid; /* é¿å…è¡Œè¢«åˆ‡æ–· */
                display: table-row !important; 
            }
            
            .table-inventory th { 
                border-bottom: 2px solid #000; 
                color: #000; 
                font-size: 9pt; 
                padding: 4px 2px;
                text-align: left;
                background-color: #fff;
            }
            
            .table-inventory td { 
                border-bottom: 1px solid #ccc; 
                font-size: 8pt; 
                padding: 2px 4px; 
                vertical-align: middle;
                height: auto; 
                line-height: 1.2; 
            }
            
            /* å–®è¡Œå‘ˆç¾è¨­å®š */
            .model-name, .model-sub { 
                font-size: 8pt; 
                margin: 0;
                display: inline; 
            }
            .model-sub { 
                color: #000 !important; 
                font-weight: 700;
                margin-right: 8px;
            }
            .model-sub span { color: #000 !important; } 
            .model-sub span.text-muted { display: none; } 
            
            /* èƒŒæ™¯è‰²è¨­å®š */
            tr.status-shortage td { background-color: #FFCCCC !important; color: #000; } 
            tr.status-surplus td { background-color: #CCEBFF !important; color: #000; } 
            tr.status-match td { background-color: #FFF !important; }
            
            /* å‚™è¨»æ¬„ä½ */
            input.form-control-sm { 
                border: none !important; 
                padding: 0; 
                font-size: 8pt; 
                background: transparent; 
                height: auto;
            }
            
            /* é å°¾ */
            #print-footer {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-top: 10px;
                padding-top: 5px;
                border-top: 1px solid #000;
                font-size: 8pt;
                page-break-inside: avoid;
            }
            .print-time { font-family: monospace; }
            .print-sign { min-width: 150px; border-bottom: 1px solid #000; text-align: center; }
            
            .diff-badge { 
                border: none; 
                padding: 0; 
                font-size: 8pt; 
                font-weight: bold;
                background: transparent !important;
                color: #000 !important;
            }
        }
    </style>
</head>
<body>

<div id="app" class="container py-3" style="max-width: 800px;">
    
    <!-- æ¨™é¡Œ -->
    <div class="app-header d-flex justify-content-between align-items-center">
        <div class="app-title d-flex align-items-center">
            <span class="text-accent me-2">â– </span>{{ appTitle }}
            <!-- ç‰ˆæœ¬è™Ÿèˆ‡è³‡è¨ŠæŒ‰éˆ• -->
            <small class="text-muted ms-2 fw-normal no-print" style="font-size: 0.8rem;">v{{ APP_VERSION }}</small>
            <button @click="showReleaseNotesModal = true" class="btn btn-sm btn-outline-secondary ms-2 p-1" style="border-radius: 50%;">
                <i class="bi bi-info-circle" style="font-size: 1.1rem;"></i>
            </button>
        </div>
    </div>
    
    <!-- é ‚ç«¯æŒ‰éˆ•å€ (åˆ—å°æ™‚éš±è—) -->
    <div class="d-flex justify-content-between align-items-center mb-3 no-print top-controls">
        <button @click="openSettings" class="btn btn-sm btn-outline-secondary rounded-1 flex-grow-1 me-2">
            <i class="bi bi-cloud-arrow-down me-1"></i>åŒ¯å…¥ç›¤é»è³‡æ–™
        </button>
        <button @click="endInventoryPDF" class="btn btn-sm btn-accent flex-grow-1">
            <i class="bi bi-file-earmark-pdf me-1"></i>çµæŸç›¤é» (PDF)
        </button>
    </div>

    <!-- æƒææ§åˆ¶å€ (åˆ—å°æ™‚éš±è—) -->
    <div class="main-card no-print">
        <div class="camera-container" v-show="isScanning">
            <div id="reader" @touchstart.prevent="focusCamera"></div> <!-- è§¸æ§å°ç„¦ -->
        </div>

        <div v-if="!isScanning">
            <button @click="startScanner" class="btn btn-primary w-100 btn-scan mb-3">
                <i class="bi bi-upc-scan"></i> å•Ÿå‹•æƒæ
            </button>
        </div>
        <div v-else class="mb-3">
            <button @click="stopScanner" class="btn btn-outline-secondary w-100 btn-scan">
                åœæ­¢æƒæ
            </button>
        </div>

        <label class="form-label text-muted small mb-1">æ‰‹å‹•è¼¸å…¥ / æœå°‹</label>
        <div class="input-group position-relative">
            <input type="text" v-model="manualInput" class="form-control" placeholder="è¼¸å…¥SKUã€å‹è™Ÿã€å“å..." @keyup.enter="handleManualInput" @input="updateSuggestions">
            <button class="btn btn-dark" @click="handleManualInput">ç¢ºèª</button>
            
            <div v-if="suggestions.length > 0" class="suggestion-list">
                <div v-for="s in suggestions" :key="s.code" class="suggestion-item" @click="selectSuggestion(s)">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="fw-bold text-dark">{{ s.name }}</span>
                        <span class="badge bg-light text-dark border rounded-0 fw-normal">{{ s.sku }}</span>
                    </div>
                    <div class="small text-muted font-monospace">{{ s.code }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- é ç±¤ (åˆ—å°æ™‚éš±è—) -->
    <ul class="nav nav-pills mb-3 no-print">
        <li class="nav-item">
            <button class="nav-link" :class="{ active: currentTab === 'diff' }" @click="currentTab = 'diff'">
                ç›¤é»å·®ç•°è¡¨ <i class="bi bi-search ms-1"></i>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" :class="{ active: currentTab === 'history' }" @click="currentTab = 'history'">
                ç´€éŒ„æ¸…å–® <span class="text-muted small">({{ records.length }})</span>
            </button>
        </li>
    </ul>

    <!-- ç›¤é»å·®ç•°è¡¨ (è¢å¹•ç‰ˆ - ä¾å·®ç•°æ’åº) -->
    <div v-show="currentTab === 'diff'">
        
        <!-- ä¸Šæ¬¡æƒæè³‡è¨Šå¡ -->
        <div v-if="lastScannedItem" class="last-scan-info no-print">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">
                    <span class="text-muted small">ä¸Šæ¬¡ç›¤é»ï¼š</span>
                    <span :class="{'text-danger': lastScannedItem.name === 'æœªçŸ¥å•†å“ (æœªå»ºæª”)'}">
                        {{ lastScannedItem.sku || lastScannedItem.name }}
                    </span>
                    <span v-if="lastScannedItem.name !== 'æœªçŸ¥å•†å“ (æœªå»ºæª”)'" class="small text-muted"> ({{ lastScannedItem.name }})</span>
                </div>
                <div class="scan-qty">
                    x {{ lastScannedItem.qty }}
                </div>
            </div>
            
            <div class="input-group mt-2">
                <input class="form-control form-control-sm" 
                       list="remarkOptions" 
                       v-model="remarkDb[lastScannedItem.code]" 
                       @input="persistRemarks"
                       placeholder="è¼¸å…¥å‚™è¨»æˆ–é¸æ“‡é¸é …...">
            </div>
        </div>
        
        <!-- çµ±è¨ˆæ•¸æ“š -->
        <div class="mb-3 d-flex gap-3 small text-muted no-print">
            <span><span class="text-danger">â—</span> è™§: {{ countStats.shortage }}</span>
            <span><span class="text-primary">â—</span> ç›ˆ: {{ countStats.surplus }}</span>
            <span><span class="text-success">â—</span> ç¬¦: {{ countStats.match }}</span>
        </div>
        
        <!-- å°ˆå±¬å·®ç•°è¡¨ç¯©é¸å™¨ -->
        <div class="input-group mb-3 no-print">
            <span class="input-group-text" style="border-radius: var(--border-radius) 0 0 var(--border-radius); border-right: none;">
                <i class="bi bi-filter"></i>
            </span>
            <input type="text" v-model="filterSearchInput" class="form-control" placeholder="ç¯©é¸ SKU/å“å/å‚™è¨»...">
        </div>
        

        <div class="main-card p-0 screen-only-table" style="border:none; background: transparent;">
            <div class="bg-white border rounded-1 overflow-hidden main-table-container">
                <div class="table-responsive">
                    <table class="table table-inventory mb-0">
                        <thead>
                            <tr>
                                <th style="width: 55%">SKU / å“å (å‹è™Ÿ)</th>
                                <th class="text-center" style="width: 15%">å¯¦/æ‡‰</th>
                                <th class="text-center" style="width: 10%">å·®</th>
                                <th style="width: 20%">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-if="filteredInventorySummary.length === 0">
                                <td colspan="4" class="text-center py-5 text-muted">ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>
                            </tr>
                            <tr v-for="item in filteredInventorySummary" :key="item.code" :class="getStatusClass(item)">
                                <td>
                                    <div class="model-name">{{ item.name }}</div>
                                    <div class="model-sub">
                                        <span class="me-2 text-accent fw-bold">{{ item.sku }}</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="small text-muted mb-1">æ‡‰:{{ item.expected }}</div>
                                    <div class="fs-6 fw-bold">{{ item.scanned }}</div>
                                </td>
                                <td class="text-center">
                                    <span class="diff-badge" :class="getBadgeClass(item)">
                                        {{ item.diff > 0 ? '+' + item.diff : item.diff }}
                                    </span>
                                </td>
                                <td>
                                    <input class="form-control form-control-sm border-0" style="background: transparent; border-bottom: 1px dashed #ccc !important; border-radius: 0;" list="remarkOptions" v-model="remarkDb[item.code]" @change="persistRemarks" placeholder="è¼¸å…¥...">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ç›¤é»å·®ç•°è¡¨ (åˆ—å°ç‰ˆ - ä¾ SKU æ’åº - å¼·åˆ¶å–®è¡Œé¡¯ç¤º) -->
    <div class="main-card p-0 print-only-table d-none" style="border:none; background: transparent;">
        <div class="bg-white main-table-container">
            <table class="table table-inventory mb-0">
                <thead>
                    <tr>
                        <th style="width: 60%">SKU / å“å (å‹è™Ÿ)</th>
                        <th class="text-center" style="width: 15%">å¯¦ / æ‡‰</th>
                        <th class="text-center" style="width: 5%">å·®</th>
                        <th style="width: 20%">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in inventorySummaryForPrint" :key="item.code" :class="getStatusClass(item)">
                        <td>
                            <span class="model-sub">{{ item.sku }}</span>
                            <span class="model-name">{{ item.name }}</span>
                        </td>
                        <td class="text-center fw-bold">
                            {{ item.scanned }} / {{ item.expected }}
                        </td>
                        <td class="text-center">
                            <span class="diff-badge">
                                {{ item.diff > 0 ? '+' + item.diff : item.diff }}
                            </span>
                        </td>
                        <td>
                            <span style="font-size: 8pt;">{{ remarkDb[item.code] }}</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <datalist id="remarkOptions">
        <option value="ç•¶æ—¥é€è²¨"></option>
        <option value="å¯„å€‰7170"></option>
        <option value="ä»£é€"></option>
        <option value="èª¤å·®"></option>
    </datalist>

    <!-- åº•éƒ¨çµ±è¨ˆ (è¢å¹•ç‰ˆ) -->
    <div v-show="currentTab === 'diff'" class="mt-3 d-flex flex-wrap justify-content-between align-items-center gap-2 no-print">
        <div class="small text-muted d-flex gap-3">
            <!-- ä½”ä½ï¼Œå¯¦éš›çµ±è¨ˆå·²ç§»è‡³ä¸Šæ–¹ -->
        </div>
    </div>

    <!-- åˆ—å°å°ˆç”¨é å°¾ -->
    <div id="print-footer">
        <div class="print-time">ç›¤é»æ™‚é–“: {{ printTime }}</div>
        <div>
            ç›¤é»äººå“¡ç°½å:
            <div class="print-sign"></div>
        </div>
    </div>

    <!-- æƒæç´€éŒ„ (åˆ—å°æ™‚éš±è—) -->
    <div v-if="currentTab === 'history'" class="no-print">
        <div class="d-flex justify-content-end mb-2">
            <button @click="clearAll" class="btn btn-sm btn-outline-secondary rounded-1">æ¸…ç©ºç´€éŒ„</button>
        </div>
        <div class="bg-white border rounded-1">
            <div v-if="records.length === 0" class="text-center text-muted py-5">å°šç„¡ç´€éŒ„</div>
            <div v-for="(item, index) in records" :key="index" class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <div style="overflow: hidden;">
                    <div class="fw-bold text-dark text-truncate">{{ item.name }}</div>
                    <div class="small text-muted font-monospace mt-1">{{ item.code }}</div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.75rem">{{ item.time }}</small>
                </div>
                <div class="d-flex align-items-center ms-3">
                    <span class="fs-5 me-3 fw-bold">x {{ item.qty }}</span>
                    <button @click="deleteItem(index)" class="btn btn-link text-muted p-1"><i class="bi bi-x-lg"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªè¦–çª— Modal -->
    <div v-if="pendingScan" class="custom-modal-overlay">
        <div class="custom-modal">
            <!-- ç¶å®šæ¨¡å¼ -->
            <div v-if="isBindingMode" class="text-center">
                <h5 class="fw-bold mb-4">ğŸ”— ç¶å®šæœªçŸ¥æ¢ç¢¼</h5>
                <div class="p-3 bg-light mb-3 border rounded-1">
                    <div class="font-monospace fw-bold text-break text-accent">{{ pendingScan.code }}</div>
                </div>
                <p class="small text-muted text-start mb-2">æœå°‹ä¸¦é¸æ“‡è¦é€£çµçš„å•†å“ï¼š</p>
                <div class="input-group mb-3">
                    <input type="text" v-model="bindSearchInput" class="form-control" placeholder="è¼¸å…¥åç¨±æˆ–å‹è™Ÿ..." @input="updateBindSuggestions">
                </div>
                <div class="list-group text-start mb-4 border rounded-0" style="max-height: 150px; overflow-y: auto;">
                    <button v-for="s in bindSuggestions" :key="s.code" class="list-group-item list-group-item-action border-0 border-bottom rounded-0" @click="confirmBind(s)">
                        <div class="fw-bold">{{ s.name }}</div>
                        <small class="text-muted">{{ s.sku }}</small>
                    </button>
                </div>
                <button @click="isBindingMode = false" class="btn btn-outline-secondary w-100">å–æ¶ˆ</button>
            </div>

            <!-- ä¸€èˆ¬ç¢ºèªæ¨¡å¼ -->
            <div v-else>
                <div class="text-center mb-4">
                    <div class="text-success mb-2" style="font-size: 2rem;">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <h5 class="fw-bold mb-1">{{ pendingScan.name }}</h5>
                    <div v-if="pendingScan.sku" class="text-accent fw-bold mb-2">{{ pendingScan.sku }}</div>
                    
                    <div v-if="pendingScan.name === 'æœªçŸ¥å•†å“ (æœªå»ºæª”)'" class="mt-3">
                        <button @click="enableBindingMode" class="btn btn-sm btn-outline-secondary rounded-1">
                            ç¶å®šæ­¤æ¢ç¢¼
                        </button>
                    </div>
                </div>

                <div class="py-2 mb-4 text-center border-top border-bottom">
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <button class="btn btn-outline-secondary rounded-circle p-0" style="width: 40px; height: 40px;" @click="adjustPendingQty(-1)"><i class="bi bi-dash"></i></button>
                        <input type="number" v-model="pendingScan.qty" class="big-qty-input" ref="qtyInput">
                        <button class="btn btn-outline-secondary rounded-circle p-0" style="width: 40px; height: 40px;" @click="adjustPendingQty(1)"><i class="bi bi-plus"></i></button>
                    </div>
                    <div class="text-muted small mt-1">ç›¤é»æ•¸é‡</div>
                </div>

                <div class="d-flex gap-2">
                    <button @click="cancelScan" class="btn btn-outline-secondary flex-grow-1">å–æ¶ˆ</button>
                    <button @click="confirmScan" class="btn btn-primary flex-grow-1">ç¢ºèª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®š Modal -->
    <div v-if="showDbModal" class="custom-modal-overlay">
        <div class="custom-modal" style="max-width: 600px;">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h5 class="fw-bold mb-0">ç›¤é»è³‡æ–™åŒ¯å…¥è¨­å®š</h5> 
                <!-- REMOVED CLOSE BUTTON -->
            </div>
            
            <div class="mb-4">
                <label class="form-label fw-bold small text-muted">Google è©¦ç®—è¡¨åŒæ­¥ (CSV ç¶²å€)</label>
                <!-- NEW: é–å®šç¶²å€çš„ç‹€æ…‹ -->
                <div class="input-group">
                    <input type="text" v-model="googleSheetUrl" class="form-control" placeholder="https://..." :readonly="isUrlLocked">
                    <button @click="syncGoogleSheet" class="btn btn-primary" :disabled="isSyncing">
                        {{ isSyncing ? 'åŒæ­¥ä¸­...' : 'åŒæ­¥' }}
                    </button>
                </div>
                <div v-if="isUrlLocked" class="form-text text-danger small">ç¶²å€å·²ç”± URL åƒæ•¸é–å®šï¼Œè«‹å‹¿æ‰‹å‹•ä¿®æ”¹ã€‚</div>
                <div v-else class="form-text small">æ ¼å¼ï¼šSKU, å“å, å‹è™Ÿ, æ‡‰ç›¤æ•¸é‡</div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold small text-muted">æ‰‹å‹•ç·¨è¼¯è³‡æ–™åº«</label>
                <textarea v-model="dbInputText" class="form-control font-monospace" rows="5" style="font-size: 0.9rem;" placeholder="SKU,å“å,å‹è™Ÿ,æ•¸é‡"></textarea>
            </div>
            
             <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                <small class="text-muted">ç›®å‰è³‡æ–™: {{ Object.keys(productDb).length }} ç­†</small>
                <!-- NEW: ç§»é™¤ disabled é™åˆ¶ï¼Œé»æ“Šå¾Œå„²å­˜ä¸¦é—œé–‰ -->
                <button @click="saveProductDbAndClose" class="btn btn-success px-4">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: é—œæ–¼/æ›´æ–°è³‡è¨Š Modal -->
    <div v-if="showReleaseNotesModal" class="custom-modal-overlay">
        <div class="custom-modal" style="max-width: 600px;">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h5 class="fw-bold mb-0">v{{ APP_VERSION }} æ›´æ–°è³‡è¨Š</h5>
                <button @click="showReleaseNotesModal = false" class="btn-close"></button>
            </div>
            
            <div class="mb-4" style="max-height: 400px; overflow-y: auto;">
                <p class="fw-bold text-accent">æ›´æ–°æ™‚é–“ï¼š2025/11/27 14:26 CST</p>
                <p class="fw-bold text-accent mt-3">æœ¬æ¬¡ç‰ˆæœ¬ (DD1.0.3) æ›´æ–°ï¼š</p>
                <ol class="small" style="padding-left: 20px;">
                    <li>1. æ™ºèƒ½ç¶²å€ä¿®å¾©ï¼šé‡å°ç¶²å€éé•·æˆ–å«æœ‰ç‰¹æ®Šç¬¦è™Ÿçš„ Google Sheet é€£çµé€²è¡Œè‡ªå‹•ä¿®å¾©ï¼Œæå‡è³‡æ–™åŒæ­¥æˆåŠŸç‡ã€‚</li>
                    <li>2. é–€å¸‚åƒæ•¸æ”¯æ´ï¼šæ”¯æ´é€é URL åƒæ•¸ (store_name, db_url) è‡ªå‹•è¼‰å…¥ä¸åŒé–€å¸‚çš„è¨­å®šèˆ‡åç¨±ã€‚</li>
                    <li>3. éŒ¯èª¤è™•ç†å„ªåŒ–ï¼šç•¶è®€å–åˆ°éŒ¯èª¤æ ¼å¼æ™‚ï¼Œæä¾›æ›´æ˜ç¢ºçš„å¼•å°è¨Šæ¯ã€‚</li>
                    <li>4. ç³»çµ±è¨­å®šå„ªåŒ–ï¼šä¿®å¾©äº†è¨­å®šè¦–çª—åœ¨é–å®šç‹€æ…‹ä¸‹ç„¡æ³•é—œé–‰çš„å•é¡Œã€‚</li>
                </ol>
            </div>
            
            <div class="text-center small mt-3 pt-3 border-top">
                å¦‚æœ‰ä»»ä½•æ“ä½œå•é¡Œï¼Œè«‹è‡´é›» **7158 æ‰¾ å®¶è¼** è©¢å•ã€‚
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                APP_VERSION: 'DD1.0.3', // Updated Version
                currentTab: 'diff',
                isScanning: false,
                html5QrcodeScanner: null,
                
                manualInput: '',
                suggestions: [],
                
                productDb: {}, 
                remarkDb: {}, 
                barcodeBindingDb: {}, 

                showDbModal: false,
                showReleaseNotesModal: false, 
                dbInputText: '',
                googleSheetUrl: '', // NEW: åˆå§‹è¨­å®šç‚ºç©º
                isSyncing: false,

                pendingScan: null,
                records: [],
                
                isBindingMode: false,
                bindSearchInput: '',
                bindSuggestions: [],

                printTime: '',
                lastScannedItem: null, 
                filterSearchInput: '', 
                
                // NEW: é–€å¸‚åç¨±èˆ‡ç¶²å€é–å®šç‹€æ…‹
                storeName: 'æ°¸è¯DCç›¤é»ç³»çµ±', 
                isUrlLocked: false
            }
        },
        computed: {
            appTitle() {
                // å‹•æ…‹æ¨™é¡Œ
                return this.storeName + ' ç›¤é»ç³»çµ±';
            },
            inventorySummary() {
                const summary = {};
                for (const [code, item] of Object.entries(this.productDb)) {
                    summary[code] = { code, ...item, scanned: 0, lastScanTime: 0 };
                }
                this.records.forEach(record => {
                    let targetCode = record.code;
                    if (!summary[targetCode]) {
                        summary[targetCode] = { 
                            code: targetCode, 
                            name: record.name, 
                            sku: record.sku || targetCode, 
                            expected: 0, 
                            scanned: 0,
                            lastScanTime: 0 
                        };
                    }
                    summary[targetCode].scanned += record.qty;
                    summary[targetCode].lastScanTime = Math.max(summary[targetCode].lastScanTime, record.timestamp || 0);
                });
                
                return Object.values(summary).map(item => {
                    item.diff = item.scanned - item.expected;
                    if (this.remarkDb[item.code] === undefined) this.remarkDb[item.code] = '';
                    
                    return item;
                }).sort((a, b) => {
                    // 1. ä¸»æ’åºï¼šå·®ç•°ç‹€æ…‹ (ç›¤è™§:1 -> ç›¤ç›ˆ:2 -> ç›¸ç¬¦:3)
                    const getPriority = (diff) => {
                        if (diff < 0) return 1; 
                        if (diff > 0) return 2; 
                        return 3; 
                    };

                    const pA = getPriority(a.diff);
                    const pB = getPriority(b.diff);
                    
                    if (pA !== pB) return pA - pB;
                    
                    // 2. æ¬¡ç´šæ’åºï¼šæ™‚é–“ (ç”±æ–°åˆ°èˆŠ - å€’åº)
                    if (a.lastScanTime !== b.lastScanTime) {
                        return b.lastScanTime - a.lastScanTime; 
                    }
                    
                    // 3. æœ«ç´šæ’åºï¼šä¾ SKU (è¼”åŠ©)
                    return (a.sku || '').localeCompare(b.sku || '', undefined, { numeric: true });
                });
            },
            
            filteredInventorySummary() {
                if (!this.filterSearchInput) {
                    return this.inventorySummary;
                }
                const normalizedInput = this.normalizeStr(this.filterSearchInput);
                
                return this.inventorySummary.filter(item => {
                    const remark = this.remarkDb[item.code] || '';
                    
                    if (this.normalizeStr(item.sku).includes(normalizedInput)) return true;
                    if (this.normalizeStr(item.name).includes(normalizedInput)) return true;
                    if (this.normalizeStr(remark).includes(normalizedInput)) return true;
                    
                    return false;
                });
            },
            
            countStats() {
                let shortage = 0, surplus = 0, match = 0;
                this.inventorySummary.forEach(i => {
                    if (i.diff < 0) shortage++;
                    else if (i.diff > 0) surplus++;
                    else if (i.scanned > 0) match++;
                });
                return { shortage, surplus, match };
            },
            inventorySummaryForPrint() {
                return [...this.inventorySummary].sort((a, b) => {
                    return (a.sku || '').localeCompare(b.sku || '', undefined, { numeric: true });
                });
            }
        },
        mounted() {
            // NEW: å„ªå…ˆè™•ç† URL åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const urlStoreName = urlParams.get('store_name');
            let urlDbUrl = urlParams.get('db_url');

            if (urlStoreName) {
                this.storeName = decodeURIComponent(urlStoreName);
            }
            
            if (urlDbUrl) {
                // vDD1.0.3: è‡ªå‹•ä¿®å¾©è¢« & æˆªæ–·çš„ Google Sheet URL
                const lostParams = ['gid', 'single', 'output', 'range'];
                lostParams.forEach(param => {
                    if (urlParams.has(param)) {
                        const val = urlParams.get(param);
                        // é¿å…é‡è¤‡æ·»åŠ  (å¦‚æœåŸæœ¬å°±æœ‰)
                        if (!urlDbUrl.includes(param + '=')) {
                            // è£œå›è¢« URLSearchParams èª¤åˆ‡çš„åƒæ•¸
                            // æ³¨æ„ï¼šé€™è£¡ç”¨ & é€£æ¥ï¼Œå› ç‚ºå®ƒå€‘æœ¬ä¾†å±¬æ–¼ db_url çš„ query string
                            urlDbUrl += `&${param}=${val}`;
                        }
                    }
                });

                this.googleSheetUrl = decodeURIComponent(urlDbUrl);
                this.isUrlLocked = true; 
                this.syncGoogleSheet(); 
            } else {
                const savedUrl = localStorage.getItem('inventory_sheet_url_updated');
                if (savedUrl) this.googleSheetUrl = savedUrl;
            }


            const savedRecords = localStorage.getItem('inventory_records');
            if (savedRecords) this.records = JSON.parse(savedRecords);
            
            const savedDb = localStorage.getItem('inventory_db_v4'); 
            if (savedDb) {
                this.productDb = JSON.parse(savedDb);
                this.dbInputText = Object.entries(this.productDb).map(([c, i]) => {
                    let displayModel = '';
                    let displayName = i.name;
                    const match = i.name.match(/(.*)\s\((.*)\)$/);
                    if (match) {
                        displayName = match[1];
                        displayModel = match[2];
                    }
                    return `${i.sku},${displayName},${displayModel},${i.expected}`; 
                }).join('\n');
            }
            
            const savedRemarks = localStorage.getItem('inventory_remarks');
            if (savedRemarks) this.remarkDb = JSON.parse(savedRemarks);
            
            const savedBindings = localStorage.getItem('inventory_bindings');
            if (savedBindings) this.barcodeBindingDb = JSON.parse(savedBindings);
        },
        methods: {
            openSettings() {
                this.showDbModal = true;
            },

            // NEW: è§¸æ§å°ç„¦åŠŸèƒ½
            focusCamera(event) {
                if (!this.isScanning || !this.html5QrcodeScanner) return;
                
                const capabilities = this.html5QrcodeScanner.getCameraCapabilities();
                if (capabilities && capabilities.focusMode.includes('manual')) {
                    this.html5QrcodeScanner.applyVideoConstraints({ 
                        advanced: [{ focusMode: 'manual' }] 
                    });
                    setTimeout(() => {
                        this.html5QrcodeScanner.applyVideoConstraints({ 
                            advanced: [{ focusMode: 'continuous' }] 
                        });
                    }, 100);
                } else {
                    console.log("Tap-to-focus not fully supported by camera/browser.");
                }
            },

            async startScanner() {
                this.isScanning = true;
                this.$nextTick(() => {
                    const config = { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 },
                        formatsToSupport: [ 
                            Html5QrcodeSupportedFormats.QR_CODE, 
                            Html5QrcodeSupportedFormats.EAN_13, 
                            Html5QrcodeSupportedFormats.CODE_128, 
                            Html5QrcodeSupportedFormats.CODE_39 
                        ]
                    };
                    this.html5QrcodeScanner = new Html5Qrcode("reader");
                    this.html5QrcodeScanner.start({ facingMode: "environment" }, config, (decodedText) => {
                        this.playBeep();
                        this.triggerConfirm(decodedText);
                    }).then(() => {
                        const readerDiv = document.getElementById("reader");
                        if (readerDiv) {
                            readerDiv.addEventListener('touchstart', this.focusCamera, { passive: true });
                        }
                    }).catch(err => {
                        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err);
                        this.isScanning = false;
                    });
                });
            },

            stopScanner() {
                if (this.html5QrcodeScanner) {
                    this.html5QrcodeScanner.stop().then(() => {
                        const readerDiv = document.getElementById("reader");
                        if (readerDiv) {
                            readerDiv.removeEventListener('touchstart', this.focusCamera);
                        }
                        
                        this.html5QrcodeScanner.clear();
                        this.html5QrcodeScanner = null;
                        this.isScanning = false;
                    }).catch(err => {
                        console.error(err);
                        this.isScanning = false;
                    });
                }
            },

            normalizeStr(str) {
                if (!str) return '';
                return str.toString().replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            },

            findProduct(input) {
                if (!input) return null;
                const cleanInput = input.trim();
                const normInput = this.normalizeStr(cleanInput);

                if (this.barcodeBindingDb[normInput]) {
                    const targetCode = this.barcodeBindingDb[normInput];
                    if (this.productDb[targetCode]) return { code: targetCode, ...this.productDb[targetCode] };
                }

                if (this.productDb[cleanInput]) return { code: cleanInput, ...this.productDb[cleanInput] };

                for (const [code, item] of Object.entries(this.productDb)) {
                    if (this.normalizeStr(item.sku) === normInput) return { code, ...item };
                    if (this.normalizeStr(item.name) === normInput) return { code, ...item };
                }

                return { code: cleanInput, name: 'æœªçŸ¥å•†å“ (æœªå»ºæª”)', sku: cleanInput, expected: 0 };
            },

            enableBindingMode() {
                this.isBindingMode = true;
                this.bindSearchInput = '';
                this.bindSuggestions = [];
            },
            updateBindSuggestions() {
                const input = this.normalizeStr(this.bindSearchInput);
                if (input.length < 2) return;
                const res = [];
                for (const [code, item] of Object.entries(this.productDb)) {
                    if (this.normalizeStr(item.name).includes(input) || this.normalizeStr(item.sku).includes(input)) {
                        res.push({code, ...item});
                        if(res.length > 10) break;
                    }
                }
                this.bindSuggestions = res;
            },
            confirmBind(targetProduct) {
                const scanCodeNorm = this.normalizeStr(this.pendingScan.code); 
                this.barcodeBindingDb[scanCodeNorm] = targetProduct.code; 
                localStorage.setItem('inventory_bindings', JSON.stringify(this.barcodeBindingDb));
                
                this.pendingScan = {
                    code: targetProduct.code,
                    name: targetProduct.name,
                    sku: targetProduct.sku,
                    expected: targetProduct.expected,
                    qty: this.pendingScan.qty
                };
                this.isBindingMode = false;
                alert("ç¶å®šæˆåŠŸï¼");
            },

            updateSuggestions() {
                const input = this.manualInput.trim();
                if (input.length < 3) { this.suggestions = []; return; }
                const normInput = this.normalizeStr(input);
                const results = [];
                for (const [code, item] of Object.entries(this.productDb)) {
                    if (this.normalizeStr(item.sku).includes(normInput) || 
                        this.normalizeStr(item.name).includes(normInput)) {
                        results.push({ code, ...item });
                        if (results.length > 10) break; 
                    }
                }
                this.suggestions = results;
            },
            selectSuggestion(item) {
                this.manualInput = '';
                this.suggestions = [];
                this.triggerConfirm(item.code);
            },
            handleManualInput() {
                if (!this.manualInput.trim()) return;
                this.suggestions = [];
                this.triggerConfirm(this.manualInput.trim());
                this.manualInput = '';
            },
            triggerConfirm(input) {
                const product = this.findProduct(input);
                this.pendingScan = { 
                    code: product.code, 
                    name: product.name, 
                    sku: product.sku,
                    expected: product.expected, 
                    qty: 1 
                };
                this.$nextTick(() => { if(this.$refs.qtyInput) this.$refs.qtyInput.focus(); });
            },
            adjustPendingQty(val) {
                if (!this.pendingScan) return;
                const newQty = parseInt(this.pendingScan.qty) + val;
                if (newQty >= 1) this.pendingScan.qty = newQty;
            },
            cancelScan() { 
                this.pendingScan = null; 
                this.isBindingMode = false;
                this.lastScannedItem = null;
            },
            confirmScan() {
                if (!this.pendingScan) return;
                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
                
                this.records.unshift({
                    code: this.pendingScan.code,
                    name: this.pendingScan.name,
                    sku: this.pendingScan.sku,
                    qty: this.pendingScan.qty,
                    time: timeStr,
                    timestamp: now.getTime() 
                });
                localStorage.setItem('inventory_records', JSON.stringify(this.records));
                
                this.lastScannedItem = {
                    code: this.pendingScan.code,
                    name: this.pendingScan.name,
                    sku: this.pendingScan.sku,
                    qty: this.pendingScan.qty
                };
                
                this.pendingScan = null;
                this.isBindingMode = false;
            },
            deleteItem(index) {
                if(confirm("åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) {
                    this.records.splice(index, 1);
                    localStorage.setItem('inventory_records', JSON.stringify(this.records));
                }
            },
            clearAll() {
                if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) {
                    this.records = [];
                    localStorage.setItem('inventory_records', JSON.stringify(this.records));
                }
            },
            async syncGoogleSheet() {
                // 1. æ¸…ç†ç¶²å€ç©ºæ ¼
                const url = this.googleSheetUrl.trim();
                if (!url) return alert('è«‹è¼¸å…¥ç¶²å€');

                // 2. ç°¡æ˜“ç¶²å€æª¢æŸ¥ (æç¤ºè€Œéé˜»æ“‹)
                if (!url.includes('output=csv')) {
                    if(!confirm("è­¦å‘Šï¼šé€™å€‹ç¶²å€çœ‹èµ·ä¾†ä¸åƒ CSV é€£çµ (ç¼ºå°‘ output=csv)ã€‚\né€™å¯èƒ½æœƒå°è‡´è®€å–å¤±æ•—ã€‚\n\næ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;
                }

                if (this.isUrlLocked) {
                    localStorage.setItem('inventory_sheet_url_updated', url);
                }
                
                this.isSyncing = true;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`é€£ç·šéŒ¯èª¤ (${res.status})`);
                    
                    const text = await res.text();

                    // 3. åš´æ ¼æª¢æŸ¥å›å‚³å…§å®¹æ˜¯å¦ç‚º HTML
                    if (text.trim().substring(0, 15).toLowerCase().startsWith('<!doctype') || 
                        text.trim().substring(0, 15).toLowerCase().startsWith('<html')) {
                        
                        throw new Error(
                            "åŒæ­¥å¤±æ•—ï¼šè®€å–åˆ°çš„æ˜¯ã€Œç¶²é  (HTML)ã€è€Œä¸æ˜¯ã€Œè³‡æ–™ (CSV)ã€ã€‚\n\n" +
                            "å¯èƒ½åŸå› ï¼š\n" +
                            "1. é€™æ˜¯ã€Œç·¨è¼¯ç¶²å€ã€è€Œéã€Œç™¼å¸ƒç¶²å€ã€ã€‚\n" +
                            "2. è©¦ç®—è¡¨æ¬Šé™æœªå…¬é–‹ (éœ€è¨­ç‚ºï¼šçŸ¥é“é€£çµè€…çš†å¯æª¢è¦–)ã€‚\n" +
                            "3. ç™¼å¸ƒè¨­å®šä¸­çš„ã€Œæ ¼å¼ã€æœªé¸æ“‡ CSVã€‚"
                        );
                    }

                    this.dbInputText = text;
                    this.saveProductDb(true);
                    
                } catch (e) { 
                    alert(e.message); 
                } 
                finally { this.isSyncing = false; }
            },
            saveProductDb(isFromSync = false) {
                const lines = this.dbInputText.split(/\r?\n/);
                const newDb = {};
                let count = 0;
                lines.forEach(line => {
                    if(!line.trim()) return;
                    const parts = line.split(/[,ï¼Œ\t]/);
                    if (parts.length >= 2) {
                        const sku = parts[0] ? parts[0].trim() : '';
                        const name = parts[1] ? parts[1].trim() : '';
                        const model = parts[2] ? parts[2].trim() : '';
                        const expected = parts[3] ? parseInt(parts[3].trim()) : 0;

                        if (sku.toLowerCase().includes('sku') || sku.includes('ç·¨è™Ÿ') || name.includes('åç¨±')) return;

                        const displayName = model ? `${name} (${model})` : name;

                        if (sku) {
                            newDb[sku] = { 
                                name: displayName, 
                                sku: sku, 
                                expected: isNaN(expected) ? 0 : expected 
                            };
                            count++;
                        }
                    }
                });
                this.productDb = newDb;
                localStorage.setItem('inventory_db_v4', JSON.stringify(newDb));
                
                if(!isFromSync) { 
                    // åªæœ‰æ‰‹å‹•å„²å­˜æ™‚æ‰å„²å­˜ç¶²å€ (åŒæ­¥å·²ç¶“è™•ç†)
                    if (!this.isUrlLocked) {
                        localStorage.setItem('inventory_sheet_url_updated', this.googleSheetUrl);
                    }
                    alert(`å„²å­˜æˆåŠŸï¼Œå…± ${count} ç­†`); 
                }
                else alert(`åŒæ­¥æˆåŠŸï¼Œå…± ${count} ç­†`);
            },
            saveProductDbAndClose() {
                this.saveProductDb(false); // åŸ·è¡Œå„²å­˜
                this.showDbModal = false; // ç›´æ¥é—œé–‰
            },
            downloadSummaryCSV() {
                let csv = "\uFEFFSKU,å“å,æ‡‰ç›¤,å¯¦ç›¤,å·®ç•°,å‚™è¨»\n";
                this.inventorySummary.forEach(i => {
                    const remark = (this.remarkDb[i.code] || '').replace(/,/g, 'ï¼Œ');
                    csv += `"${i.code}","${i.name}",${i.expected},${i.scanned},${i.diff},"${remark}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `ç›¤é»å·®ç•°è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            },
            endInventoryPDF() {
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                this.printTime = `${yyyy}-${mm}-${dd} ${hh}:${min}`;
                this.$nextTick(() => { window.print(); });
            },
            persistRemarks() { localStorage.setItem('inventory_remarks', JSON.stringify(this.remarkDb)); },
            playBeep() {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = 'sine'; osc.frequency.value = 1000; gain.gain.value = 0.1;
                osc.start(); setTimeout(() => osc.stop(), 100);
            },
            getStatusClass(item) {
                if (item.scanned === 0 && item.expected > 0) return 'status-shortage'; 
                if (item.diff === 0) return 'status-match';
                if (item.diff < 0) return 'status-shortage';
                return 'status-surplus';
            },
            getBadgeClass(item) {
                if (item.diff === 0) return 'bg-match';
                if (item.diff < 0) return 'bg-shortage';
                return 'bg-surplus';
            }
        }
    }).mount('#app');
</script>

</body>
</html>
